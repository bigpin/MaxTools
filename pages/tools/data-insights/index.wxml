<view class="container">
  <!-- 订阅按钮区域 -->
  <view class="subscribe-section">
    <view class="subscribe-content">
      <view class="subscribe-info">
        <t-icon name="notification" size="32rpx" color="#d32f2f" />
        <view class="subscribe-text-wrapper">
          <text class="subscribe-title">数据洞察订阅</text>
          <text class="subscribe-desc">{{isSubscribed ? '已订阅，每日自动推送最新洞察' : '订阅后每日自动推送最新数据洞察'}}</text>
        </view>
      </view>
      <t-button 
        wx:if="{{!isSubscribed}}"
        theme="danger" 
        size="small"
        bindtap="handleSubscribe"
        loading="{{subscribing}}"
      >
        订阅
      </t-button>
      <t-button 
        wx:else
        theme="default" 
        variant="outline"
        size="small"
        bindtap="handleUnsubscribe"
        loading="{{unsubscribing}}"
      >
        取消订阅
      </t-button>
    </view>
    <!-- 订阅提示 -->
    <view class="subscribe-tip">
      <t-icon name="info-circle" size="24rpx" color="#ff9800" />
      <text class="subscribe-tip-text">建议在授权弹窗中勾选「总是保持以上选择」以持续接收推送</text>
    </view>
  </view>

  <!-- 日期选择器 -->
  <t-picker
    visible="{{datePickerVisible}}"
    value="{{[datePickerType === 'start' ? startDate : endDate]}}"
    title="选择{{datePickerType === 'start' ? '开始' : '结束'}}日期"
    bind:change="onDatePickerConfirm"
    bind:cancel="onDatePickerCancel"
  >
    <t-picker-item mode="date" min="{{minDate}}" max="{{maxDate}}" />
  </t-picker>

  <!-- 特征类型选择器 -->
  <t-picker
    visible="{{signalTypePickerVisible}}"
    value="{{[signalTypeIndex]}}"
    title="选择特征类型"
    bind:change="onSignalTypePickerConfirm"
    bind:cancel="onSignalTypePickerCancel"
  >
    <t-picker-item options="{{signalTypeOptions}}" />
  </t-picker>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <t-loading theme="circular" size="48rpx" text="加载中..." />
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{currentPageData.length === 0}}" class="empty-state">
    <t-icon name="file-search" size="120rpx" color="#ccc" />
    <text class="empty-text">暂无数据</text>
    <text class="empty-desc">请调整筛选条件或稍后再试</text>
  </view>

  <!-- 信号列表 -->
  <view wx:else class="signals-list">
    <view 
      wx:for="{{currentPageData}}" 
      wx:key="date"
      class="date-group"
    >
      <!-- 日期标题 -->
      <view class="date-header" bindtap="toggleDateGroup" data-date="{{item.date}}">
        <view class="date-header-left">
          <t-icon 
            name="{{expandedDateGroups[item.date] ? 'chevron-down' : 'chevron-right'}}" 
            size="28rpx" 
            color="#fff" 
          />
          <t-icon name="calendar" size="32rpx" color="#fff" />
          <text class="date-title">{{item.date}}</text>
          <text class="date-count">({{item.stocks.length}}条数据)</text>
        </view>
        <view class="date-header-right">
          <text class="date-toggle-text">{{expandedDateGroups[item.date] ? '收起' : '展开'}}</text>
        </view>
      </view>

      <!-- 股票卡片列表 -->
      <view class="signals-container {{expandedDateGroups[item.date] ? 'show' : ''}}">
        <view 
          wx:for="{{item.stocks}}"
          wx:for-item="stock"
          wx:key="stock_code"
          class="stock-card"
        >
          <!-- 卡片头部（点击展开/收起） -->
          <view 
            class="card-header"
            bindtap="toggleCardExpand"
            data-id="{{stock.stock_code}}_{{item.date}}"
          >
            <view 
              class="stock-info-wrapper"
              catchtap="onStockCodeTap"
              data-code="{{stock.stock_code}}"
            >
              <text class="stock-name">{{stock.stock_name}}</text>
              <text class="stock-code">{{stock.stock_code}}</text>
            </view>
            <view class="card-header-right">
              <view class="stock-summary-card">
                <view class="summary-item">
                  <text class="summary-label">整体胜率</text>
                  <text class="summary-value success-rate-highlight">{{stock.overall_success_rate || 0}}%</text>
                </view>
                <view class="summary-divider"></view>
                <view class="summary-item">
                  <text class="summary-label">特征数</text>
                  <text class="summary-value">{{stock.signals.length}}</text>
                </view>
              </view>
              <t-icon 
                name="{{expandedCards[stock.stock_code + '_' + item.date] ? 'chevron-up' : 'chevron-down'}}" 
                size="32rpx" 
                color="#999" 
              />
            </view>
          </view>

          <!-- 展开后的详情 -->
          <view wx:if="{{expandedCards[stock.stock_code + '_' + item.date]}}" class="card-detail-content">
            <!-- 特征类型统计 -->
            <view wx:if="{{stock.signalTypeStats}}" class="signal-type-stats">
              <view 
                wx:for="{{stock.signalTypeStats}}"
                wx:for-item="stat"
                wx:key="type"
                class="signal-type-stat-item"
              >
                <text class="stat-type">{{stat.type}}:</text>
                <text class="stat-count">{{stat.count}}个</text>
              </view>
            </view>
            
            <!-- 特征列表 -->
            <view class="signals-list-content">
              <view 
                wx:for="{{stock.signals}}"
                wx:for-item="signal"
                wx:key="_id"
                class="signal-item"
              >
                <view class="signal-item-header">
                  <view class="signal-type-badge">
                    <t-tag 
                      theme="{{signal.signal_success_rate >= 70 ? 'success' : signal.signal_success_rate >= 60 ? 'warning' : 'primary'}}" 
                      variant="light" 
                      size="small"
                      shape="round"
                    >
                      {{signal.signal_type_cn || signal.signal_label || signal.signal_type}}
                    </t-tag>
                  </view>
                  <text class="signal-date">{{signal.signal_date}}</text>
                </view>
                <view class="signal-item-content">
                  <view class="signal-metrics-grid">
                    <view class="metric-card">
                      <text class="metric-label-small">准确率</text>
                      <text class="metric-value-large" style="color: {{signal.signal_success_rate >= 70 ? '#00c853' : signal.signal_success_rate >= 60 ? '#ff6f00' : '#d32f2f'}}">{{signal.signal_success_rate || 0}}%</text>
                    </view>
                    <view class="metric-card">
                      <text class="metric-label-small">历史出现</text>
                      <text class="metric-value-large">{{signal.signal_total || 0}}次</text>
                    </view>
                    <view class="metric-card">
                      <text class="metric-label-small">收盘价</text>
                      <text class="metric-value-large price-value">¥{{signal.close || '-'}}</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 其他日期列表 -->
    <view wx:if="{{otherDatesData && otherDatesData.length > 0}}" class="other-dates-section">
      <view class="other-dates-title">
        <t-icon name="calendar" size="32rpx" color="#d32f2f" />
        <text class="other-dates-title-text">其他日期</text>
      </view>
      
      <view 
        wx:for="{{otherDatesData}}"
        wx:for-item="dateItem"
        wx:key="date"
        class="other-date-item"
      >
        <!-- 日期头部 -->
        <view 
          class="other-date-header"
          bindtap="toggleOtherDate"
          data-date="{{dateItem.date}}"
        >
          <view class="other-date-header-left">
            <t-icon 
              name="{{expandedOtherDates[dateItem.date] ? 'chevron-down' : 'chevron-right'}}" 
              size="28rpx" 
              color="#d32f2f" 
            />
            <t-icon name="calendar" size="28rpx" color="#d32f2f" />
            <text class="other-date-title">{{dateItem.date}}</text>
            <text class="other-date-count">({{dateItem.stockCount}}条数据)</text>
          </view>
          <view class="other-date-header-right">
            <text class="other-date-toggle-text">{{expandedOtherDates[dateItem.date] ? '收起' : '展开'}}</text>
            <t-loading 
              wx:if="{{loadingOtherDates[dateItem.date]}}"
              theme="circular"
              size="24rpx"
            />
          </view>
        </view>

        <!-- 展开后的股票列表 -->
        <view 
          wx:if="{{expandedOtherDates[dateItem.date] && dateItem.loaded}}"
          class="other-date-stocks-container"
        >
          <view 
            wx:for="{{dateItem.stocks}}"
            wx:for-item="stock"
            wx:key="stock_code"
            class="stock-card"
          >
            <!-- 卡片头部（点击展开/收起） -->
            <view 
              class="card-header"
              bindtap="toggleCardExpand"
              data-id="{{stock.stock_code}}_{{dateItem.date}}"
            >
              <view 
                class="stock-info-wrapper"
                catchtap="onStockCodeTap"
                data-code="{{stock.stock_code}}"
              >
                <text class="stock-name">{{stock.stock_name}}</text>
                <text class="stock-code">{{stock.stock_code}}</text>
              </view>
              <view class="card-header-right">
                <view class="stock-summary-card">
                  <view class="summary-item">
                    <text class="summary-label">整体胜率</text>
                    <text class="summary-value success-rate-highlight">{{stock.overall_success_rate || 0}}%</text>
                  </view>
                  <view class="summary-divider"></view>
                  <view class="summary-item">
                    <text class="summary-label">特征数</text>
                    <text class="summary-value">{{stock.signals.length}}</text>
                  </view>
                </view>
                <t-icon 
                  name="{{expandedCards[stock.stock_code + '_' + dateItem.date] ? 'chevron-up' : 'chevron-down'}}" 
                  size="32rpx" 
                  color="#999" 
                />
              </view>
            </view>

            <!-- 展开后的详情 -->
            <view wx:if="{{expandedCards[stock.stock_code + '_' + dateItem.date]}}" class="card-detail-content">
              <!-- 特征类型统计 -->
              <view wx:if="{{stock.signalTypeStats}}" class="signal-type-stats">
                <view 
                  wx:for="{{stock.signalTypeStats}}"
                  wx:for-item="stat"
                  wx:key="type"
                  class="signal-type-stat-item"
                >
                  <text class="stat-type">{{stat.type}}:</text>
                  <text class="stat-count">{{stat.count}}个</text>
                </view>
              </view>

              <!-- 特征列表 -->
              <view class="signals-list-content">
                <view 
                  wx:for="{{stock.signals}}"
                  wx:for-item="signal"
                  wx:key="_id"
                  class="signal-item"
                >
                  <view class="signal-item-header">
                    <view class="signal-type-badge">
                      <t-tag 
                        theme="{{signal.signal_success_rate >= 70 ? 'success' : signal.signal_success_rate >= 60 ? 'warning' : 'primary'}}" 
                        variant="light" 
                        size="small"
                        shape="round"
                      >
                        {{signal.signal_type_cn || signal.signal_label || signal.signal_type}}
                      </t-tag>
                    </view>
                    <text class="signal-date">{{signal.signal_date}}</text>
                  </view>
                  <view class="signal-item-content">
                    <view class="signal-metrics-grid">
                      <view class="metric-card">
                        <text class="metric-label-small">准确率</text>
                        <text class="metric-value-large" style="color: {{signal.signal_success_rate >= 70 ? '#00c853' : signal.signal_success_rate >= 60 ? '#ff6f00' : '#d32f2f'}}">{{signal.signal_success_rate || 0}}%</text>
                      </view>
                      <view class="metric-card">
                        <text class="metric-label-small">历史出现</text>
                        <text class="metric-value-large">{{signal.signal_total || 0}}次</text>
                      </view>
                      <view class="metric-card">
                        <text class="metric-label-small">收盘价</text>
                        <text class="metric-value-large price-value">¥{{signal.close || '-'}}</text>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 规则说明链接 -->
  <view class="rules-section">
    <view 
      class="rules-header"
      bindtap="openRulesArticle"
    >
      <view class="rules-header-left">
        <t-icon name="info-circle" size="32rpx" color="#d32f2f" />
        <text class="rules-title">分析规则说明</text>
      </view>
      <t-icon 
        name="chevron-right" 
        size="28rpx" 
        color="#d32f2f" 
      />
    </view>
  </view>

  <!-- 测试按钮（左下角悬浮） -->
  <view class="test-button-float" wx:if="{{showTestButton}}" bindtap="testNotification">
    <t-icon name="setting" size="40rpx" color="#fff" />
    <text class="test-button-text">测试</text>
  </view>
</view>
